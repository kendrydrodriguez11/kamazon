{% extends "layouts/base_layout.html" %}
{% load static %}

{% block content %}
    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h1 class="text-4xl font-bold text-kamazon-gray-dark mb-2">
                <i class="fa-solid fa-credit-card text-kamazon-teal mr-3"></i>
                Finalizar Compra
            </h1>
            <p class="text-kamazon-gray">Completa tu información de pago</p>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">

            <div class="bg-white rounded-xl border border-gray-200 p-8">
                <h2 class="text-2xl font-bold text-kamazon-gray-dark mb-6">
                    Resumen del Pedido
                </h2>

                <div class="space-y-4 mb-6 max-h-80 overflow-y-auto">
                    {% for item in cart_items %}
                        <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                            <img src="{{ item.product.get_image }}"
                                 alt="{{ item.product.name }}"
                                 class="w-16 h-16 rounded-lg object-cover">

                            <div class="flex-grow">
                                <h4 class="font-medium text-kamazon-gray-dark">{{ item.product.name }}</h4>
                                <p class="text-sm text-kamazon-gray">
                                    Cantidad: {{ item.quantity }} × ${{ item.product.price|floatformat:2 }}
                                </p>
                            </div>

                            <div class="text-right">
                                <p class="font-semibold text-kamazon-gray-dark">
                                    ${{ item.get_subtotal|floatformat:2 }}
                                </p>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div class="border-t border-gray-200 pt-6 space-y-3">
                    <div class="flex justify-between">
                        <span class="text-kamazon-gray">Subtotal:</span>
                        <span class="font-semibold text-kamazon-gray-dark">
                            ${{ subtotal|floatformat:2 }}
                        </span>
                    </div>

                    <div class="flex justify-between">
                        <span class="text-kamazon-gray">Impuesto ({{ tax_rate|floatformat:0 }}%):</span>
                        <span class="font-semibold text-kamazon-gray-dark">
                            ${{ tax_amount|floatformat:2 }}
                        </span>
                    </div>

                    <hr class="border-gray-200">

                    <div class="flex justify-between text-xl font-bold">
                        <span class="text-kamazon-gray-dark">Total:</span>
                        <span class="text-kamazon-teal">${{ total|floatformat:2 }}</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl border border-gray-200 p-8">
                <h2 class="text-2xl font-bold text-kamazon-gray-dark mb-6">
                    Información de Pago
                </h2>

                <form id="payment-form">
                    {% csrf_token %}
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-kamazon-gray mb-2">
                            Información de la Tarjeta
                        </label>
                        <div id="card-element" class="p-4 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div id="card-errors" class="mt-2 text-red-600 text-sm"></div>
                    </div>

                    <div class="flex justify-center gap-2">
                        <button id="submit-payment"
                                class="cursor-pointer w-full bg-kamazon-teal hover:bg-kamazon-teal-dark text-white font-semibold py-4 px-6 rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="flex items-center justify-center gap-2">
                            <i class="fa-solid fa-lock"></i>
                            <span id="button-text">Pagar ${{ total|floatformat:2 }}</span>
                            <div id="spinner" class="hidden animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                        </span>
                        </button>
                        <a href="{% url 'commerce:cart-detail' %}"
                           class="w-full bg-gray-300 hover:bg-gray-400 text-black font-semibold py-4 px-6 rounded-lg text-center">
                            Cancelar
                        </a>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="text-sm text-kamazon-gray flex items-center justify-center gap-2">
                            <i class="fa-solid fa-shield-check text-green-600"></i>
                            Pago seguro con cifrado SSL
                        </p>
                    </div>
                </form>
            </div>

        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://js.stripe.com/basil/stripe.js"></script>
    <script>
        const stripe = Stripe('{{ stripe_publishable_key }}');
        const csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value;
        const elements = stripe.elements();

        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#424770',
                    '::placeholder': {
                        color: '#aab7c4',
                    },
                },
            },
        });

        cardElement.mount('#card-element');

        cardElement.on('change', ({error}) => {
            const displayError = document.getElementById('card-errors');
            if (error) {
                displayError.textContent = error.message;
            } else {
                displayError.textContent = '';
            }
        });

        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-payment');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            submitButton.disabled = true;
            buttonText.textContent = 'Procesando...';
            spinner.classList.remove('hidden');

            try {
                const response = await fetch('{% url "api:cart-payment-create" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                });

                const {client_secret, error} = await response.json();

                if (error) {
                    throw new Error(error);
                }

                const {error: stripeError, paymentIntent} = await stripe.confirmCardPayment(client_secret, {
                    payment_method: {
                        card: cardElement,
                    }
                });

                if (stripeError) {
                    throw new Error(stripeError.message);
                }

                if (paymentIntent.status === 'succeeded') {
                    await fetch('{% url "api:cart-payment-success" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({
                            payment_intent_id: paymentIntent.id
                        })
                    });

                    window.location.href = '{% url "commerce:cart-detail" %}';
                }

            } catch (error) {
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = error.message;

                submitButton.disabled = false;
                buttonText.textContent = 'Pagar ${{ total|floatformat:2 }}';
                spinner.classList.add('hidden');
            }
        });
    </script>
{% endblock %}